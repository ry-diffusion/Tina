import { Button, VerticalBox, HorizontalBox, ListView, LineEdit, ScrollView, Palette, StandardButton } from "std-widgets.slint";

export struct AccountInfo {
    id: string,
    name: string,
    phone-number: string,
    is-connected: bool,
    is-syncing: bool,
}

export struct ChatItem {
    jid: string,
    name: string,
    last-message: string,
    last-message-time: string,
    unread-count: int,
    is-group: bool,
    is-selected: bool,
}

export struct MessageItem {
    id: string,
    sender-name: string,
    content: string,
    timestamp: string,
    is-from-me: bool,
    message-type: string,
}

export global AppState {
    in-out property <string> current-account-id;
    in-out property <string> current-chat-jid;
    in-out property <string> current-chat-name;
    in-out property <bool> is-loading: false;
    in-out property <string> status-message: "Welcome to Tina";
    in-out property <string> qr-code-data;
    in-out property <bool> show-qr-dialog: false;
    in-out property <string> sync-status;

    in-out property <[AccountInfo]> accounts: [];
    in-out property <[ChatItem]> chats: [];
    in-out property <[MessageItem]> messages: [];

    callback send-message(string);
    callback select-chat(string);
    callback select-account(string);
    callback create-account(string, string);
    callback start-account(string);
    callback stop-account(string);
    callback refresh-chats();
    callback load-messages(string);
}

component Avatar inherits Rectangle {
    in property <string> name;
    in property <color> bg-color: #25D366;
    in property <length> size: 40px;
    
    width: size;
    height: size;
    border-radius: size / 2;
    background: bg-color;
    
    Text {
        text: "‚óè";
        color: white;
        font-size: size * 0.4;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
}

component AccountListItem inherits Rectangle {
    in property <AccountInfo> account;
    in property <bool> selected;
    
    callback clicked();
    
    height: 56px;
    background: selected ? Palette.accent-background : transparent;
    border-radius: 8px;
    
    TouchArea {
        clicked => { root.clicked(); }
        
        HorizontalLayout {
            padding: 12px;
            spacing: 12px;
            
            Avatar {
                name: account.name;
                bg-color: account.is-connected ? #25D366 : Palette.border;
                size: 32px;
            }
            
            VerticalLayout {
                alignment: center;
                spacing: 2px;
                
                Text {
                    text: account.name != "" ? account.name : account.id;
                    color: Palette.foreground;
                    font-size: 14px;
                    font-weight: 500;
                    overflow: elide;
                }
                
                Text {
                    text: account.is-syncing ? "Syncing..." : (account.is-connected ? account.phone-number : "Disconnected");
                    color: Palette.foreground.transparentize(40%);
                    font-size: 12px;
                }
            }
        }
    }
}

component ChatListItem inherits Rectangle {
    in property <ChatItem> chat;
    
    callback clicked();
    
    height: 72px;
    background: chat.is-selected ? Palette.accent-background : transparent;
    border-radius: 8px;
    
    TouchArea {
        clicked => { root.clicked(); }
        
        HorizontalLayout {
            padding: 12px;
            spacing: 12px;
            
            Avatar {
                name: chat.name;
                bg-color: chat.is-group ? #4A5568 : #25D366;
                size: 48px;
            }
            
            VerticalLayout {
                alignment: center;
                spacing: 4px;
                
                HorizontalLayout {
                    Text {
                        text: chat.name;
                        color: Palette.foreground;
                        font-size: 14px;
                        font-weight: 500;
                        overflow: elide;
                        horizontal-stretch: 1;
                    }
                    
                    Text {
                        text: chat.last-message-time;
                        color: Palette.foreground.transparentize(50%);
                        font-size: 11px;
                    }
                }
                
                HorizontalLayout {
                    Text {
                        text: chat.last-message;
                        color: Palette.foreground.transparentize(40%);
                        font-size: 13px;
                        overflow: elide;
                        horizontal-stretch: 1;
                    }
                    
                    if chat.unread-count > 0 : Rectangle {
                        width: 20px;
                        height: 20px;
                        border-radius: 10px;
                        background: #25D366;
                        
                        Text {
                            text: chat.unread-count > 99 ? "99+" : chat.unread-count;
                            color: white;
                            font-size: 10px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }
    }
}

component MessageBubble inherits Rectangle {
    in property <MessageItem> message;
    
    property <bool> is-mine: message.is-from-me;
    
    height: content-layout.preferred-height + 16px;
    background: is-mine ? #005C4B : Palette.background.darker(0.1);
    border-radius: 12px;
    
    content-layout := VerticalLayout {
        padding: 8px;
        padding-left: 12px;
        padding-right: 12px;
        spacing: 4px;
        
        if !is-mine : Text {
            text: message.sender-name;
            color: #25D366;
            font-size: 12px;
            font-weight: 600;
        }
        
        Text {
            text: message.content;
            color: Palette.foreground;
            font-size: 14px;
            wrap: word-wrap;
        }
        
        HorizontalLayout {
            alignment: end;
            
            Text {
                text: message.timestamp;
                color: Palette.foreground.transparentize(50%);
                font-size: 11px;
            }
        }
    }
}

component Sidebar inherits Rectangle {
    in-out property <length> sidebar-width: 320px;
    in property <bool> collapsed: false;
    
    width: collapsed ? 0px : sidebar-width;
    background: Palette.background.darker(0.05);
    border-radius: 0;
    
    VerticalLayout {
        padding: 8px;
        spacing: 8px;
        
        Rectangle {
            height: 48px;
            background: transparent;
            
            HorizontalLayout {
                padding-left: 12px;
                padding-right: 12px;
                alignment: space-between;
                
                Text {
                    text: "Tina";
                    color: Palette.foreground;
                    font-size: 20px;
                    font-weight: 700;
                    vertical-alignment: center;
                }
                
                Button {
                    text: "+";
                    clicked => {
                        AppState.create-account("new-account", "New Account");
                    }
                }
            }
        }
        
        Rectangle {
            height: 1px;
            background: Palette.border;
        }
        
        Text {
            text: "Accounts";
            color: Palette.foreground.transparentize(40%);
            font-size: 12px;
            font-weight: 600;
            horizontal-alignment: left;
        }
        
        ListView {
            height: 120px;
            
            for account[idx] in AppState.accounts : AccountListItem {
                account: account;
                selected: account.id == AppState.current-account-id;
                clicked => {
                    AppState.select-account(account.id);
                }
            }
        }
        
        Rectangle {
            height: 1px;
            background: Palette.border;
        }
        
        HorizontalLayout {
            alignment: space-between;
            
            Text {
                text: "Chats";
                color: Palette.foreground.transparentize(40%);
                font-size: 12px;
                font-weight: 600;
                vertical-alignment: center;
            }
            
            Button {
                text: "Refresh";
                enabled: AppState.current-account-id != "";
                clicked => {
                    AppState.refresh-chats();
                }
            }
        }
        
        ListView {
            vertical-stretch: 1;
            
            for chat[idx] in AppState.chats : ChatListItem {
                chat: chat;
                clicked => {
                    AppState.select-chat(chat.jid);
                }
            }
        }
        
        Rectangle {
            height: 32px;
            background: transparent;
            
            Text {
                text: AppState.sync-status;
                color: Palette.foreground.transparentize(50%);
                font-size: 11px;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
    }
}

component MessageView inherits Rectangle {
    background: Palette.background;
    
    VerticalLayout {
        if AppState.current-chat-jid == "" : Rectangle {
            vertical-stretch: 1;
            
            VerticalLayout {
                alignment: center;
                spacing: 16px;
                
                Text {
                    text: "Welcome to Tina";
                    color: Palette.foreground;
                    font-size: 24px;
                    font-weight: 600;
                    horizontal-alignment: center;
                }
                
                Text {
                    text: "Select a chat to start messaging";
                    color: Palette.foreground.transparentize(40%);
                    font-size: 14px;
                    horizontal-alignment: center;
                }
            }
        }
        
        if AppState.current-chat-jid != "" : Rectangle {
            height: 64px;
            background: Palette.background.darker(0.05);
            
            HorizontalLayout {
                padding: 16px;
                spacing: 12px;
                alignment: start;
                
                Avatar {
                    name: AppState.current-chat-name;
                    size: 40px;
                }
                
                VerticalLayout {
                    alignment: center;
                    
                    Text {
                        text: AppState.current-chat-name;
                        color: Palette.foreground;
                        font-size: 16px;
                        font-weight: 500;
                    }
                }
            }
        }
        
        if AppState.current-chat-jid != "" : ScrollView {
            vertical-stretch: 1;
            
            VerticalLayout {
                padding: 16px;
                spacing: 8px;
                alignment: end;
                
                for message[idx] in AppState.messages : HorizontalLayout {
                    alignment: message.is-from-me ? end : start;
                    
                    MessageBubble {
                        message: message;
                        max-width: 400px;
                    }
                }
            }
        }
        
        if AppState.current-chat-jid != "" : Rectangle {
            height: 72px;
            background: Palette.background.darker(0.05);
            
            HorizontalLayout {
                padding: 16px;
                spacing: 12px;
                
                message-input := LineEdit {
                    horizontal-stretch: 1;
                    placeholder-text: "Type a message...";
                    
                    accepted => {
                        if self.text != "" {
                            AppState.send-message(self.text);
                            self.text = "";
                        }
                    }
                }
                
                Button {
                    text: "Send";
                    enabled: message-input.text != "";
                    clicked => {
                        if message-input.text != "" {
                            AppState.send-message(message-input.text);
                            message-input.text = "";
                        }
                    }
                }
            }
        }
    }
}

component QrCodeDialog inherits Rectangle {
    in property <bool> show-dialog: false;
    in property <string> qr-data;
    
    callback close();
    
    if show-dialog : Rectangle {
        background: #000000.transparentize(50%);
        
        TouchArea {
            clicked => { root.close(); }
        }
        
        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: 320px;
            height: 400px;
            background: Palette.background;
            border-radius: 16px;
            
            TouchArea {}
            
            VerticalLayout {
                padding: 24px;
                spacing: 16px;
                alignment: center;
                
                Text {
                    text: "Scan QR Code";
                    color: Palette.foreground;
                    font-size: 18px;
                    font-weight: 600;
                    horizontal-alignment: center;
                }
                
                Text {
                    text: "Open WhatsApp on your phone and scan this code to connect";
                    color: Palette.foreground.transparentize(40%);
                    font-size: 13px;
                    horizontal-alignment: center;
                    wrap: word-wrap;
                }
                
                Rectangle {
                    width: 200px;
                    height: 200px;
                    background: white;
                    border-radius: 8px;
                    
                    Text {
                        text: qr-data != "" ? "QR Ready" : "Waiting...";
                        color: black;
                        font-size: 14px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
                
                Button {
                    text: "Close";
                    clicked => { root.close(); }
                }
            }
        }
    }
}

export component TinaApp inherits Window {
    title: "Tina - WhatsApp Desktop";
    min-width: 800px;
    min-height: 600px;
    preferred-width: 1200px;
    preferred-height: 800px;
    background: Palette.background;
    
    HorizontalLayout {
        Sidebar {
            sidebar-width: 320px;
        }
        
        Rectangle {
            width: 1px;
            background: Palette.border;
        }
        
        MessageView {
            horizontal-stretch: 1;
        }
    }
    
    if AppState.is-loading : Rectangle {
        background: Palette.background.transparentize(30%);
        
        VerticalLayout {
            alignment: center;
            
            Text {
                text: "Loading...";
                color: Palette.foreground;
                font-size: 16px;
                horizontal-alignment: center;
            }
        }
    }
    
    QrCodeDialog {
        show-dialog: AppState.show-qr-dialog;
        qr-data: AppState.qr-code-data;
        
        close => {
            AppState.show-qr-dialog = false;
        }
    }
}
